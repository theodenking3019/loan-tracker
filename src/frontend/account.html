<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Account</title>
    <link rel="stylesheet" href="styles/styles.css">
    <style>
        /* You may want to move these styles to styles.css for consistency */
        #userInfo {
            position: absolute;
            top: 10px;
            left: 10px;
        }

        #logoutBtn {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        #repaymentFormContainer, #borrowFormContainer {
            text-align: center;
            margin-top: 100px;
            font-size: large;
        }
    </style>
</head>

<body>

    <!-- Logout button -->
    <div id="logoutBtn">
        <button onclick="location.href='/logout'">Logout</button>
    </div>

    <!-- User Info -->
    <div id="userInfo">
        <p>Email: <span id="userEmail"></span></p>
        <p>Ethereum Address: <span id="userEthAddress"></span></p>
    </div>

    <!-- Loan Amount Input -->
    <div id="borrowFormContainer">
        <h2>Request a Loan</h2>
        <form id="borrowForm" action="/borrow" method="post">
            <div>
                <label for="amount">Enter your desired loan amount in USD: </label>
                <input type="number" id="amount" name="amount" min="1" max="10000" required>
            </div>
            <div>
                <button type="submit">Request Loan</button>
            </div>
        </form>
    </div>
    
    <!-- Repayment Form - initially hidden -->
    <div id="repaymentFormContainer" style="display: none;">
        <h2>Repayment</h2>
        <p>Your principal amount: $<span id="totalLoanAmount"></span></p>
        <p>Your outstanding balance: $<span id="outstandingBalance"></span></p>
        <form id="repaymentForm" action="/repay" method="post">
            <div>
                <label for="repaymentAmount">Enter repayment amount in USD: </label>
                <input type="number" id="repaymentAmount" name="repaymentAmount" min="1" required>
            </div>
            <div>
                <button type="submit">Submit Payment</button>
            </div>
        </form>
    </div>

    <script>
        // Load username, wallet address, and loan information
        window.onload = async function() {
            try {
                const response = await fetch('/account-data');
                if (!response.ok) throw new Error('Failed to fetch user data');
                
                const data = await response.json();
                const principal = data.totalLoanAmount;
                const outstanding = data.outstandingBalance;
    
                document.getElementById('userEmail').textContent = data.userEmail;
                document.getElementById('userEthAddress').textContent = data.userEthereumAddress;

                if (outstanding && outstanding > 0) {
                    document.getElementById('borrowFormContainer').style.display = 'none';   // Hide the borrow form
                    document.getElementById('repaymentFormContainer').style.display = 'block';  // Show the repayment form
                    document.getElementById('outstandingBalance').textContent = principal; // Display the outstanding balance
                    document.getElementById('totalLoanAmount').textContent = outstanding; // Display the outstanding balance
                }
                else {
                    document.getElementById('borrowFormContainer').style.display = 'block';   // Hide the borrow form
                    document.getElementById('repaymentFormContainer').style.display = 'none';  // Show the repayment form
                }
            } catch (error) {
                console.error(error);
                // Potentially redirect to login page or show error
                window.location.href = '/login';
            }
        }

        // Handle submission of borrowing data
        const borrowForm = document.getElementById('borrowForm');

        borrowForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const amount = borrowForm.amount.value;

            const response = await fetch(borrowForm.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    amount
                })
            })

            const responseData = await response.json();

            // Handle response here (show success message, redirect, etc.)
            if (responseData.success) {
            // Redirect to the home page
                window.location.reload();
            } else if (responseData.error) {
                // Handle error, like showing an error message to the user
                console.log("Error!")
            }  
        });

        // Handle submission of repayment data
        const repaymentForm = document.getElementById('repaymentForm');

        repaymentForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const amount = repaymentForm.repaymentAmount.value;

            const response = await fetch(repaymentForm.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    amount
                })
            })

            const responseData = await response.json();

            // Handle response here (show success message, redirect, etc.)
            if (responseData.success) {
            // Redirect to the home page
                window.location.reload();
            } else if (responseData.error) {
                // Handle error, like showing an error message to the user
                console.log("Error!")
            }  
        });

    </script>

</body>

</html>
